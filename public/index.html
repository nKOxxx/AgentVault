<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîê AgentVault</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 500px;
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 5px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 14px;
    }
    
    .content {
      padding: 30px;
    }
    
    .setup-screen, .unlock-screen, .vault-screen, .connect-screen {
      display: none;
    }
    
    .setup-screen.active, .unlock-screen.active, .vault-screen.active, .connect-screen.active {
      display: block;
    }
    
    .input-group {
      margin-bottom: 20px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }
    
    .input-group input, .input-group select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: box-shadow 0.2s, opacity 0.2s;
    }

    .btn:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      opacity: 0.95;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
      margin-top: 10px;
    }
    
    .btn-danger {
      background: #ff4757;
      color: white;
    }
    
    .btn-success {
      background: #2ed573;
      color: white;
    }
    
    .vault-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .vault-header h2 {
      font-size: 20px;
      color: #333;
    }
    
    .key-count {
      background: #667eea;
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }
    
    .key-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .key-item {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      border-left: 4px solid #667eea;
      transition: box-shadow 0.2s, border-color 0.2s;
      position: relative;
      left: 0;
    }

    .key-item:hover {
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
      border-left-color: #764ba2;
    }
    
    .key-item.warning {
      border-left-color: #ffa502;
    }
    
    .key-item.danger {
      border-left-color: #ff4757;
    }
    
    .key-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .key-name {
      font-weight: 600;
      font-size: 16px;
      color: #333;
    }
    
    .key-service {
      font-size: 12px;
      color: #667eea;
      background: rgba(102, 126, 234, 0.1);
      padding: 2px 8px;
      border-radius: 10px;
    }
    
    .key-meta {
      font-size: 13px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .key-actions {
      display: flex;
      gap: 8px;
    }
    
    .key-actions button {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-share {
      background: #2ed573;
      color: white;
    }
    
    .btn-share:disabled {
      background: #a8a8a8;
      cursor: not-allowed;
    }
    
    .btn-share.shared {
      background: #747d8c;
    }
    
    .btn-delete {
      background: #ff4757;
      color: white;
    }

    .btn-edit {
      background: #3742fa;
      color: white;
    }

    .btn-unshare {
      background: #ffa502;
      color: white;
    }

    .btn-share-all {
      background: #3742fa;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 15px;
    }
    
    .btn-share-all:disabled {
      background: #a8a8a8;
      cursor: not-allowed;
    }
    
    .shared-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #2ed573;
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 12px;
      margin-left: 8px;
    }
    
    .unshared-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #ffa502;
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 12px;
      margin-left: 8px;
    }
    
    .key-item.shared {
      border-left: 4px solid #2ed573;
    }
    
    .key-item.unshared {
      border-left: 4px solid #ffa502;
    }
    
    .add-key-form {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      display: none;
    }
    
    .add-key-form.active {
      display: block;
    }
    
    .alert {
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #666;
      margin-bottom: 15px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ff4757;
    }
    
    .status-dot.connected {
      background: #2ed573;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 15px;
      opacity: 0.3;
    }
    
    .warning-badge {
      background: #ffa502;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
    }
    
    .progress-bar {
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      margin-top: 10px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
    }
    
    .info-text {
      font-size: 13px;
      color: #666;
      margin-top: 15px;
      text-align: center;
    }
    
    .info-text strong {
      color: #333;
    }
    
    .password-requirements {
      margin-top: 10px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      font-size: 12px;
    }
    
    .req-item {
      color: #666;
      margin: 4px 0;
      transition: color 0.3s;
    }
    
    .req-item.valid {
      color: #2ed573;
    }
    
    .req-item.invalid {
      color: #ff4757;
    }
    
    .connect-screen {
      display: none;
    }
    
    .connect-screen.active {
      display: block;
    }
    
    .clawbot-icon {
      font-size: 64px;
      text-align: center;
      margin: 20px 0;
    }
    
    .key-validation {
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      display: none;
    }
    
    .key-validation.valid {
      background: #d4edda;
      color: #155724;
      display: block;
    }
    
    .key-validation.invalid {
      background: #f8d7da;
      color: #721c24;
      display: block;
    }
    
    .key-validation.warning {
      background: #fff3cd;
      color: #856404;
      display: block;
    }
    
    .settings-screen {
      display: none;
    }
    
    .settings-screen.active {
      display: block;
    }
    
    .settings-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .settings-section h3 {
      margin-bottom: 15px;
      color: #333;
      font-size: 16px;
    }
    
    .danger-zone {
      background: #fff5f5;
      border: 1px solid #ff4757;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .danger-zone h3 {
      color: #ff4757;
      margin-bottom: 10px;
    }
    
    .danger-zone p {
      color: #666;
      font-size: 13px;
      margin-bottom: 15px;
    }
    
    .vault-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .vault-nav h2 {
      font-size: 20px;
      color: #333;
    }
    
    .nav-buttons {
      display: flex;
      gap: 10px;
    }
    
    .nav-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .nav-btn:hover {
      transform: translateY(-1px);
    }
    
    .nav-btn-primary {
      background: #667eea;
      color: white;
    }
    
    .nav-btn-secondary {
      background: #f0f0f0;
      color: #333;
    }
    
    .nav-btn-danger {
      background: #ff4757;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîê AgentVault</h1>
      <p>Secure credential manager for AI agents</p>
    </div>
    
    <div class="content">
      <!-- Setup Screen -->
      <div class="setup-screen active" id="setupScreen">
        <h2 style="margin-bottom: 20px; color: #333;">Welcome to AgentVault</h2>
        <p style="color: #666; margin-bottom: 25px; line-height: 1.6;">
          Your local, encrypted vault for API keys and passwords. 
          <strong>Your data never leaves your machine.</strong>
        </p>
        
        <div class="input-group">
          <label>Create Master Password</label>
          <input type="password" id="setupPassword" placeholder="Create secure password" onkeyup="checkPasswordStrength()">
          <div class="password-requirements" id="passwordRequirements">
            <div class="req-item" id="req-length">‚úó At least 8 characters</div>
            <div class="req-item" id="req-upper">‚úó One uppercase letter (A-Z)</div>
            <div class="req-item" id="req-lower">‚úó One lowercase letter (a-z)</div>
            <div class="req-item" id="req-number">‚úó One number (0-9)</div>
            <div class="req-item" id="req-symbol">‚úó One symbol (!@#$%^&*)</div>
          </div>
        </div>
        
        <div class="input-group">
          <label>Confirm Password</label>
          <input type="password" id="confirmPassword" placeholder="Confirm your password">
        </div>
        
        <button class="btn btn-primary" id="createVaultBtn" onclick="initializeVault()">Create Vault</button>
        
        <div class="info-text">
          <strong>üîí Security:</strong> Your password is used to encrypt all data.
          <br>It is never stored or transmitted.
        </div>
      </div>
      
      <!-- Connect Screen -->
      <div class="connect-screen" id="connectScreen">
        <div class="clawbot-icon">ü¶û</div>
        <h2 style="margin-bottom: 15px; color: #333; text-align: center;">Connect to OpenClaw</h2>
        <p style="color: #666; margin-bottom: 25px; line-height: 1.6; text-align: center;">
          AgentVault is ready! Now connect with your AI assistant to securely share keys.
        </p>
        
        <div id="connectionStatus" style="text-align: center; margin-bottom: 20px;">
          <div class="status-dot" id="connectStatusDot" style="margin: 0 auto 10px;"></div>
          <p id="connectStatusText" style="color: #666; font-size: 14px;">Waiting for connection...</p>
        </div>
        
        <button class="btn btn-primary" onclick="connectToOpenClaw()">Connect to OpenClaw Agent</button>
        <button class="btn btn-secondary" onclick="skipConnection()">Skip for now</button>
        
        <div class="info-text" style="margin-top: 20px;">
          <strong>‚ÑπÔ∏è Tip:</strong> You can connect later from the vault screen.
        </div>
      </div>
      
      <!-- Unlock Screen -->
      <div class="unlock-screen" id="unlockScreen">
        <div style="text-align: center; margin-bottom: 25px;">
          <div style="font-size: 48px; margin-bottom: 10px;">üîí</div>
          <h2 style="color: #333;">Vault Locked</h2>
          <p style="color: #666; font-size: 14px; margin-top: 8px;">Enter your master password to unlock</p>
        </div>
        
        <div class="input-group">
          <label>Master Password</label>
          <input type="password" id="unlockPassword" placeholder="Enter your password" onkeypress="handleUnlockKeypress(event)">
        </div>
        
        <button class="btn btn-primary" id="unlockBtn" onclick="unlockVault()">üîì Unlock Vault</button>
        
        <div class="progress-bar" style="margin-top: 20px;">
          <div class="progress-fill" id="keyCountBar" style="width: 0%"></div>
        </div>
        <p class="info-text" id="keyCountText">0 / 20 keys stored</p>
        
        <button class="btn btn-secondary" onclick="resetVault()" style="margin-top: 20px; font-size: 12px;">
          ‚ö†Ô∏è Reset Vault (Delete All Data)
        </button>
      </div>
      
      <!-- Vault Screen -->
      <div class="vault-screen" id="vaultScreen">
        <div class="connection-status">
          <div class="status-dot" id="connectionDot"></div>
          <span id="connectionText">OpenClaw disconnected</span>
        </div>
        
        <div class="vault-header">
          <h2>Your Keys</h2>
          <div class="key-count" id="vaultKeyCount">0/20</div>
        </div>
        
        <button class="btn-share-all" id="shareAllBtn" onclick="shareAllKeys()" disabled>
          üì§ Share All Unshared Keys
        </button>
        <p id="shareAllStatus" style="font-size: 12px; color: #666; margin-bottom: 15px; display: none;"></p>
        
        <div class="add-key-form" id="addKeyForm">
          <h3 style="margin-bottom: 15px; color: #333;">Add New Key</h3>
          
          <div class="input-group">
            <label>Key Name</label>
            <input type="text" id="keyName" placeholder="e.g., Supabase Production">
          </div>
          
          <div class="input-group">
            <label>Service</label>
            <select id="keyService" onchange="onServiceChange()">
              <option value="">Select service...</option>
              <optgroup label="Social Media">
                <option value="twitter">X (Twitter)</option>
              </optgroup>
              <optgroup label="Cloud & Hosting">
                <option value="aws">AWS</option>
                <option value="render">Render</option>
                <option value="vercel">Vercel</option>
                <option value="cloudflare">Cloudflare</option>
                <option value="digitalocean">DigitalOcean</option>
                <option value="firebase">Firebase</option>
              </optgroup>
              <optgroup label="Databases">
                <option value="supabase">Supabase</option>
                <option value="postgres">PostgreSQL</option>
                <option value="mysql">MySQL</option>
                <option value="mongodb">MongoDB</option>
                <option value="redis">Redis</option>
              </optgroup>
              <optgroup label="AI & LLMs">
                <option value="openai">OpenAI</option>
                <option value="anthropic">Anthropic (Claude)</option>
                <option value="moonshot">Moonshot (Kimi)</option>
                <option value="elevenlabs">ElevenLabs</option>
                <option value="deepgram">Deepgram</option>
              </optgroup>
              <optgroup label="Our Products">
                <option value="moltbook">Moltbook</option>
                <option value="openclaw">OpenClaw</option>
                <option value="agentvault">AgentVault</option>
                <option value="agentdiplomacy">AgentDiplomacy</option>
                <option value="memorybridge">MemoryBridge</option>
              </optgroup>
              <optgroup label="Communication">
                <option value="telegram">Telegram</option>
                <option value="slack">Slack</option>
                <option value="discord">Discord</option>
                <option value="twilio">Twilio</option>
                <option value="sendgrid">SendGrid</option>
              </optgroup>
              <optgroup label="Dev Tools">
                <option value="github">GitHub</option>
                <option value="google">Google APIs</option>
                <option value="notion">Notion</option>
                <option value="figma">Figma</option>
              </optgroup>
              <optgroup label="Other">
                <option value="stripe">Stripe</option>
                <option value="other">Other</option>
              </optgroup>
            </select>
          </div>
          
          <div class="input-group">
            <label>URL (optional)</label>
            <input type="text" id="keyUrl" placeholder="e.g., https://project.supabase.co">
          </div>
          
          <!-- Dynamic credential fields container -->
          <div id="dynamicFields">
            <div class="input-group">
              <label>Secret Value</label>
              <input type="password" id="keyValue" placeholder="Paste your API key here" onkeyup="validateKeyPattern()">
              <div class="key-validation" id="keyValidation"></div>
            </div>
          </div>
          
          <!-- X/Twitter specific fields (hidden by default) -->
          <div id="twitterFields" style="display: none;">
            <div class="input-group">
              <label>OAuth 1.0a - API Key (Consumer Key)</label>
              <input type="password" id="twitterApiKey" placeholder="Your API Key">
            </div>
            <div class="input-group">
              <label>OAuth 1.0a - API Secret (Consumer Secret)</label>
              <input type="password" id="twitterApiSecret" placeholder="Your API Secret">
            </div>
            <div class="input-group">
              <label>OAuth 1.0a - Access Token</label>
              <input type="password" id="twitterAccessToken" placeholder="Your Access Token">
            </div>
            <div class="input-group">
              <label>OAuth 1.0a - Access Token Secret</label>
              <input type="password" id="twitterAccessTokenSecret" placeholder="Your Access Token Secret">
            </div>
            <div class="input-group">
              <label>OAuth 2.0 - Bearer Token</label>
              <input type="password" id="twitterBearerToken" placeholder="Your Bearer Token">
            </div>
            <div class="input-group">
              <label>Client ID (OAuth 2.0)</label>
              <input type="password" id="twitterClientId" placeholder="Your Client ID">
            </div>
            <div class="input-group">
              <label>Client Secret (OAuth 2.0)</label>
              <input type="password" id="twitterClientSecret" placeholder="Your Client Secret">
            </div>
          </div>
          
          <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="autoShareKey" style="width: auto;">
            <label for="autoShareKey" style="margin: 0; font-weight: normal;">
              Share with OpenClaw Agent immediately
            </label>
          </div>
          
          <button class="btn btn-primary" onclick="addKey()">Save Key</button>
          <button class="btn btn-secondary" onclick="toggleAddForm()">Cancel</button>
        </div>

        <!-- Edit Key Form (hidden by default) -->
        <div class="add-key-form" id="editKeyForm">
          <h3 style="margin-bottom: 15px; color: #333;">Edit Key</h3>

          <div class="input-group">
            <label>Key Name</label>
            <input type="text" id="editKeyName" placeholder="e.g., Supabase Production">
          </div>

          <div class="input-group">
            <label>Service</label>
            <select id="editKeyService">
              <option value="">Select service...</option>
              <optgroup label="Social Media">
                <option value="twitter">X (Twitter)</option>
              </optgroup>
              <optgroup label="Cloud & Hosting">
                <option value="aws">AWS</option>
                <option value="render">Render</option>
                <option value="vercel">Vercel</option>
                <option value="cloudflare">Cloudflare</option>
                <option value="digitalocean">DigitalOcean</option>
                <option value="firebase">Firebase</option>
              </optgroup>
              <optgroup label="Databases">
                <option value="supabase">Supabase</option>
                <option value="postgres">PostgreSQL</option>
                <option value="mysql">MySQL</option>
                <option value="mongodb">MongoDB</option>
                <option value="redis">Redis</option>
              </optgroup>
              <optgroup label="AI & LLMs">
                <option value="openai">OpenAI</option>
                <option value="anthropic">Anthropic (Claude)</option>
                <option value="moonshot">Moonshot (Kimi)</option>
                <option value="elevenlabs">ElevenLabs</option>
                <option value="deepgram">Deepgram</option>
              </optgroup>
              <optgroup label="Our Products">
                <option value="moltbook">Moltbook</option>
                <option value="openclaw">OpenClaw</option>
                <option value="agentvault">AgentVault</option>
                <option value="agentdiplomacy">AgentDiplomacy</option>
                <option value="memorybridge">MemoryBridge</option>
              </optgroup>
              <optgroup label="Communication">
                <option value="telegram">Telegram</option>
                <option value="slack">Slack</option>
                <option value="discord">Discord</option>
                <option value="twilio">Twilio</option>
                <option value="sendgrid">SendGrid</option>
              </optgroup>
              <optgroup label="Dev Tools">
                <option value="github">GitHub</option>
                <option value="google">Google APIs</option>
                <option value="notion">Notion</option>
                <option value="figma">Figma</option>
              </optgroup>
              <optgroup label="Other">
                <option value="stripe">Stripe</option>
                <option value="other">Other</option>
              </optgroup>
            </select>
          </div>

          <div class="input-group">
            <label>URL (optional)</label>
            <input type="text" id="editKeyUrl" placeholder="e.g., https://project.supabase.co">
          </div>

          <div class="input-group">
            <label>Secret Value</label>
            <input type="password" id="editKeyValue" placeholder="New API key value">
          </div>

          <div class="input-group" style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="editResetRotation" style="width: auto;">
            <label for="editResetRotation" style="margin: 0; font-weight: normal;">
              Reset rotation timer (mark as freshly rotated)
            </label>
          </div>

          <button class="btn btn-primary" id="saveEditBtn" onclick="saveEditedKey()">Save Changes</button>
          <button class="btn btn-secondary" onclick="hideEditForm()">Cancel</button>
        </div>

        <button class="btn btn-primary" id="showAddBtn" onclick="toggleAddForm()" style="margin-bottom: 20px;">
          + Add New Key
        </button>
        
        <div id="alerts"></div>
        
        <div class="key-list" id="keyList">
          <!-- Keys will be loaded here -->
        </div>
        
        <button class="btn btn-secondary" onclick="lockVault()" style="margin-top: 20px; border: 2px solid #667eea;">
          üîí Lock Vault
        </button>
      </div>
    </div>
  </div>

  <script>
    // State
    let ws = null;
    let keys = [];
    let passwordValid = false;
    
    // Password validation patterns
    const patterns = {
      length: /.{8,}/,
      upper: /[A-Z]/,
      lower: /[a-z]/,
      number: /[0-9]/,
      symbol: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/
    };
    
    // Key patterns by service
    const keyPatterns = {
      // Cloud & Hosting
      aws: /^AKIA[A-Z0-9]{16}$/,
      render: /^rnd_[a-zA-Z0-9]{25,}$/,
      vercel: /^[a-zA-Z0-9]{24}$/,
      cloudflare: /^[a-f0-9]{37}$/,
      digitalocean: /^dop_v1_[a-f0-9]{64}$/,
      firebase: /^AIza[0-9A-Za-z_-]{35}$/,
      
      // Databases
      supabase: /^sb_[a-z]+_[A-Za-z0-9]{40,}$/,
      postgres: /^postgres:\/\//,
      mysql: /^mysql:\/\//,
      mongodb: /^mongodb(\+srv)?:\/\//,
      redis: /^rediss?:\/\//,
      
      // AI & LLMs
      openai: /^sk-[A-Za-z0-9]{32,}$/,
      anthropic: /^sk-ant-[a-zA-Z0-9]{48,}$/,
      moonshot: /^[a-f0-9]{32}$/,
      elevenlabs: /^[a-f0-9]{32}$/,
      deepgram: /^[a-f0-9]{32}$/,
      
      // Communication
      telegram: /^[0-9]{8,10}:[A-Za-z0-9_-]{35}$/,
      slack: /^xox[baprs]-[0-9]{10,13}-[0-9]{10,13}(-[a-zA-Z0-9]{24})?$/,
      discord: /^[A-Za-z0-9_-]{20,30}\.[A-Za-z0-9_-]{6}\.[A-Za-z0-9_-]{27}$/,
      twilio: /^SK[0-9a-f]{32}$|^AC[0-9a-f]{32}$/,
      sendgrid: /^SG\.[A-Za-z0-9]{22}\.[A-Za-z0-9]{43}$/,
      
      // Dev Tools
      github: /^ghp_[A-Za-z0-9]{36}$|^gho_[A-Za-z0-9]{36}$|^github_pat_[A-Za-z0-9]{22}_[A-Za-z0-9]{59}$/,
      google: /^AIza[0-9A-Za-z_-]{35}$/,
      notion: /^secret_[A-Za-z0-9]{43}$/,
      figma: /^figd_[A-Za-z0-9]{40}$/
    };
    
    // Service display names
    const serviceDisplayNames = {
      // Social Media
      twitter: 'X (Twitter)',
      
      // Cloud & Hosting
      aws: 'AWS',
      render: 'Render',
      vercel: 'Vercel',
      cloudflare: 'Cloudflare',
      digitalocean: 'DigitalOcean',
      firebase: 'Firebase',
      
      // Databases
      supabase: 'Supabase',
      postgres: 'PostgreSQL',
      mysql: 'MySQL',
      mongodb: 'MongoDB',
      redis: 'Redis',
      
      // AI & LLMs
      openai: 'OpenAI',
      anthropic: 'Anthropic',
      moonshot: 'Moonshot',
      elevenlabs: 'ElevenLabs',
      deepgram: 'Deepgram',
      
      // Our Products
      moltbook: 'Moltbook',
      openclaw: 'OpenClaw',
      agentvault: 'AgentVault',
      agentdiplomacy: 'AgentDiplomacy',
      memorybridge: 'MemoryBridge',
      
      // Communication
      telegram: 'Telegram',
      slack: 'Slack',
      discord: 'Discord',
      twilio: 'Twilio',
      sendgrid: 'SendGrid',
      
      // Dev Tools
      github: 'GitHub',
      google: 'Google APIs',
      notion: 'Notion',
      figma: 'Figma',
      
      // Other
      stripe: 'Stripe',
      other: 'Other'
    };
    
    // Check password strength
    function checkPasswordStrength() {
      const password = document.getElementById('setupPassword').value;
      let valid = true;
      
      // Check each requirement
      const lengthValid = patterns.length.test(password);
      const upperValid = patterns.upper.test(password);
      const lowerValid = patterns.lower.test(password);
      const numberValid = patterns.number.test(password);
      const symbolValid = patterns.symbol.test(password);
      
      document.getElementById('req-length').textContent = (lengthValid ? '‚úì' : '‚úó') + ' At least 8 characters';
      document.getElementById('req-length').className = 'req-item ' + (lengthValid ? 'valid' : 'invalid');
      
      document.getElementById('req-upper').textContent = (upperValid ? '‚úì' : '‚úó') + ' One uppercase letter (A-Z)';
      document.getElementById('req-upper').className = 'req-item ' + (upperValid ? 'valid' : 'invalid');
      
      document.getElementById('req-lower').textContent = (lowerValid ? '‚úì' : '‚úó') + ' One lowercase letter (a-z)';
      document.getElementById('req-lower').className = 'req-item ' + (lowerValid ? 'valid' : 'invalid');
      
      document.getElementById('req-number').textContent = (numberValid ? '‚úì' : '‚úó') + ' One number (0-9)';
      document.getElementById('req-number').className = 'req-item ' + (numberValid ? 'valid' : 'invalid');
      
      document.getElementById('req-symbol').textContent = (symbolValid ? '‚úì' : '‚úó') + ' One symbol (!@#$%^&*)';
      document.getElementById('req-symbol').className = 'req-item ' + (symbolValid ? 'valid' : 'invalid');
      
      // Check if all valid
      valid = lengthValid && upperValid && lowerValid && numberValid && symbolValid;
      
      passwordValid = valid;
      return valid;
    }
    
    // Validate key pattern against selected service
    function validateKeyPattern() {
      const service = document.getElementById('keyService').value;
      const value = document.getElementById('keyValue').value;
      const validationDiv = document.getElementById('keyValidation');
      
      if (!service || !value) {
        validationDiv.style.display = 'none';
        return true;
      }
      
      const pattern = keyPatterns[service];
      if (!pattern) {
        validationDiv.style.display = 'none';
        return true;
      }
      
      const isValid = pattern.test(value);
      const serviceDisplay = serviceDisplayNames[service] || service;
      
      if (isValid) {
        validationDiv.className = 'key-validation valid';
        validationDiv.textContent = `‚úì Valid ${serviceDisplay} key format`;
      } else {
        validationDiv.className = 'key-validation invalid';
        validationDiv.textContent = `‚ö†Ô∏è This doesn't look like a ${serviceDisplay} key. Wrong format or wrong service selected.`;
      }
      
      return isValid;
    }
    
    // Handle service selection change
    function onServiceChange() {
      const service = document.getElementById('keyService').value;
      const dynamicFields = document.getElementById('dynamicFields');
      const twitterFields = document.getElementById('twitterFields');
      
      // Reset validation
      validateKeyPattern();
      
      // Show/hide Twitter-specific fields
      if (service === 'twitter') {
        dynamicFields.style.display = 'none';
        twitterFields.style.display = 'block';
      } else {
        dynamicFields.style.display = 'block';
        twitterFields.style.display = 'none';
      }
    }
    
    // Check vault status on load
    async function checkStatus() {
      console.log('checkStatus called');
      try {
        const response = await fetch('/api/status');
        const status = await response.json();
        console.log('Status:', status);
        
        if (!status.initialized) {
          console.log('Showing setup screen');
          showScreen('setup');
        } else if (!status.unlocked) {
          console.log('Showing unlock screen');
          showScreen('unlock');
          updateKeyCount(status.keyCount, status.maxKeys);
          // Focus password field
          setTimeout(() => {
            const passwordField = document.getElementById('unlockPassword');
            if (passwordField) passwordField.focus();
          }, 100);
        } else {
          console.log('Showing vault screen');
          showScreen('vault');
          loadKeys();
          connectWebSocket();
        }
      } catch (e) {
        console.error('checkStatus error:', e);
        showAlert('Failed to connect to AgentVault server', 'error');
      }
    }
    
    function showScreen(screen) {
      document.querySelectorAll('.setup-screen, .unlock-screen, .vault-screen, .connect-screen').forEach(el => {
        el.classList.remove('active');
      });
      document.getElementById(screen + 'Screen').classList.add('active');
      
      // Reset unlock button when showing unlock screen
      if (screen === 'unlock') {
        const unlockBtn = document.getElementById('unlockBtn');
        if (unlockBtn) {
          unlockBtn.textContent = 'üîì Unlock Vault';
          unlockBtn.disabled = false;
        }
        const passwordField = document.getElementById('unlockPassword');
        if (passwordField) {
          passwordField.value = '';
        }
      }
    }
    
    function connectToOpenClaw() {
      connectWebSocket();
      showScreen('vault');
      loadKeys();
    }
    
    function skipConnection() {
      showScreen('vault');
      loadKeys();
    }
    
    function updateKeyCount(count, max) {
      document.getElementById('keyCountBar').style.width = (count / max * 100) + '%';
      document.getElementById('keyCountText').textContent = `${count} / ${max} keys stored`;
      document.getElementById('vaultKeyCount').textContent = `${count}/${max}`;
    }
    
    async function initializeVault() {
      console.log('initializeVault called');
      const password = document.getElementById('setupPassword').value;
      const confirm = document.getElementById('confirmPassword').value;
      
      console.log('Password entered:', password ? 'yes' : 'no');
      
      // Validate password requirements
      const lengthValid = patterns.length.test(password);
      const upperValid = patterns.upper.test(password);
      const lowerValid = patterns.lower.test(password);
      const numberValid = patterns.number.test(password);
      const symbolValid = patterns.symbol.test(password);
      const allValid = lengthValid && upperValid && lowerValid && numberValid && symbolValid;
      
      console.log('Validation:', {lengthValid, upperValid, lowerValid, numberValid, symbolValid, allValid});
      
      if (!allValid) {
        showAlert('Password does not meet requirements. Need: 8+ chars, uppercase, lowercase, number, symbol.', 'error');
        return;
      }
      
      if (password !== confirm) {
        showAlert('Passwords do not match', 'error');
        return;
      }
      
      console.log('Sending init request...');
      try {
        const response = await fetch('/api/init', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        
        console.log('Response:', response.status);
        
        if (response.ok) {
          console.log('Vault created, showing connect screen');
          showScreen('connect');
        } else {
          const error = await response.json();
          showAlert(error.error, 'error');
        }
      } catch (e) {
        console.error('Error:', e);
        showAlert('Failed to create vault: ' + e.message, 'error');
      }
    }
    
    function handleUnlockKeypress(event) {
      if (event.key === 'Enter') {
        unlockVault();
      }
    }
    
    async function unlockVault() {
      const password = document.getElementById('unlockPassword').value;
      const btn = document.getElementById('unlockBtn');
      
      if (!password) {
        showAlert('Please enter your password', 'error');
        return;
      }
      
      // Show loading state
      const originalText = btn.textContent;
      btn.textContent = 'üîì Unlocking...';
      btn.disabled = true;
      
      // Create abort controller for timeout
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
      
      try {
        const response = await fetch('/api/unlock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (response.ok) {
          showScreen('vault');
          loadKeys();
          connectWebSocket();
          showAlert('‚úÖ Vault unlocked successfully', 'success');
        } else {
          const error = await response.json();
          showAlert('‚ùå ' + (error.error || 'Invalid password'), 'error');
          btn.textContent = originalText;
          btn.disabled = false;
        }
      } catch (e) {
        clearTimeout(timeoutId);
        if (e.name === 'AbortError') {
          showAlert('‚ùå Request timed out. Server may be busy.', 'error');
        } else {
          showAlert('‚ùå Failed to unlock vault: ' + e.message, 'error');
        }
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }
    
    async function resetVault() {
      if (!confirm('‚ö†Ô∏è WARNING: This will DELETE ALL KEYS and reset the vault.\n\nThis action cannot be undone.\n\nAre you sure?')) {
        return;
      }
      
      if (!confirm('Final confirmation: ALL YOUR KEYS WILL BE LOST FOREVER.\n\nType "DELETE" to confirm:')) {
        return;
      }
      
      try {
        const response = await fetch('/api/reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          showAlert('Vault reset. Please refresh the page.', 'success');
          setTimeout(() => location.reload(), 1500);
        } else {
          showAlert('Failed to reset vault', 'error');
        }
      } catch (e) {
        showAlert('Failed to reset vault', 'error');
      }
    }
    
    async function lockVault() {
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = 'üîí Locking...';
      btn.disabled = true;
      
      try {
        // Call server to clear encryption key from memory
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch('/api/logout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (response.ok) {
          // Close WebSocket
          if (ws) {
            ws.close();
            ws = null;
          }
          
          // Clear any sensitive data
          keys = [];
          
          // Show unlock screen
          showScreen('unlock');
          
          // Reset unlock button state (in case it was stuck)
          const unlockBtn = document.getElementById('unlockBtn');
          if (unlockBtn) {
            unlockBtn.textContent = 'üîì Unlock Vault';
            unlockBtn.disabled = false;
          }
          
          // Clear password field
          const passwordField = document.getElementById('unlockPassword');
          if (passwordField) {
            passwordField.value = '';
            passwordField.focus();
          }
          
          showAlert('üîí Vault locked successfully', 'success');
        } else {
          showAlert('‚ùå Failed to lock vault', 'error');
          btn.textContent = originalText;
          btn.disabled = false;
        }
      } catch (e) {
        console.error('Lock vault error:', e);
        showAlert('‚ùå Failed to lock vault: ' + e.message, 'error');
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }
    
    async function loadKeys() {
      try {
        const response = await fetch('/api/keys');
        keys = await response.json();
        renderKeys();
        updateKeyCount(keys.length, 20);
      } catch (e) {
        showAlert('Failed to load keys', 'error');
      }
    }
    
    function renderKeys() {
      const list = document.getElementById('keyList');
      const shareAllBtn = document.getElementById('shareAllBtn');
      
      // Update share all button
      const unsharedCount = keys.filter(k => !k.is_shared).length;
      if (shareAllBtn) {
        shareAllBtn.disabled = unsharedCount === 0 || !ws || ws.readyState !== WebSocket.OPEN;
        shareAllBtn.textContent = unsharedCount === 0 ? '‚úÖ All Keys Shared' : `üì§ Share All Unshared Keys (${unsharedCount})`;
      }
      
      if (keys.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
            <p>No keys stored yet</p>
            <p style="font-size: 12px; margin-top: 5px;">Add your first key to get started</p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = keys.map(key => {
        const warningClass = key.needs_rotation ? (key.days_until_rotation < 0 ? 'danger' : 'warning') : '';
        const sharedClass = key.is_shared ? 'shared' : 'unshared';
        const warningBadge = key.needs_rotation ? `<span class="warning-badge">Rotate in ${key.days_until_rotation} days</span>` : '';
        const shareStatus = key.is_shared 
          ? `<span class="shared-indicator">‚úì Shared${key.shared_with ? ` with ${key.shared_with}` : ''}</span>`
          : `<span class="unshared-indicator">‚ö† Not shared</span>`;
        const shareBtnText = key.is_shared ? 'Share Again' : 'Share with OpenClaw Agent';
        const shareBtnClass = key.is_shared ? 'btn-share shared' : 'btn-share';
        
        const serviceName = serviceDisplayNames[key.service] || key.service || 'Other';
        
        const unshareBtn = key.is_shared ? `<button class="btn-unshare" onclick="unshareKey('${key.id}')" id="unshare-btn-${key.id}">Revoke Share</button>` : '';
        
        return `
          <div class="key-item ${warningClass} ${sharedClass}" id="key-item-${key.id}">
            <div class="key-header">
              <div>
                <span class="key-name">${key.name}</span>
                ${shareStatus}
                ${warningBadge}
              </div>
              <span class="key-service">${serviceName}</span>
            </div>
            <div class="key-meta">
              ${key.url ? `üîó ${key.url}<br>` : ''}
              üïê ${key.days_since_rotation} days old
            </div>
            <div class="key-actions">
              <button class="${shareBtnClass}" onclick="shareKey('${key.id}')" id="share-btn-${key.id}">${shareBtnText}</button>
              ${unshareBtn}
              <button class="btn-edit" onclick="editKey('${key.id}')">Edit</button>
              <button class="btn-delete" onclick="deleteKey('${key.id}')">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function toggleAddForm() {
      document.getElementById('addKeyForm').classList.toggle('active');
      document.getElementById('showAddBtn').style.display = 
        document.getElementById('addKeyForm').classList.contains('active') ? 'none' : 'block';
    }
    
    async function addKey() {
      const name = document.getElementById('keyName').value;
      const service = document.getElementById('keyService').value;
      const url = document.getElementById('keyUrl').value;
      const autoShare = document.getElementById('autoShareKey').checked;
      
      if (!name) {
        showAlert('Name is required', 'error');
        return;
      }
      
      let value;
      let credentials = {};
      
      // Handle Twitter/X multi-field input
      if (service === 'twitter') {
        const apiKey = document.getElementById('twitterApiKey').value;
        const apiSecret = document.getElementById('twitterApiSecret').value;
        const accessToken = document.getElementById('twitterAccessToken').value;
        const accessTokenSecret = document.getElementById('twitterAccessTokenSecret').value;
        const bearerToken = document.getElementById('twitterBearerToken').value;
        const clientId = document.getElementById('twitterClientId').value;
        const clientSecret = document.getElementById('twitterClientSecret').value;
        
        // At least one credential required
        if (!apiKey && !apiSecret && !accessToken && !accessTokenSecret && !bearerToken && !clientId && !clientSecret) {
          showAlert('At least one Twitter credential is required', 'error');
          return;
        }
        
        // Store as JSON object with all credentials
        credentials = {
          apiKey,
          apiSecret,
          accessToken,
          accessTokenSecret,
          bearerToken,
          clientId,
          clientSecret
        };
        
        // Create a summary for display
        const filledFields = Object.entries(credentials).filter(([k, v]) => v).map(([k]) => k);
        value = JSON.stringify({ ...credentials, _summary: `Twitter API (${filledFields.length} credentials)` });
      } else {
        // Standard single value
        value = document.getElementById('keyValue').value;
        
        if (!value) {
          showAlert('Secret value is required', 'error');
          return;
        }
        
        // Validate key pattern if service selected
        if (service && !validateKeyPattern()) {
          const validationDiv = document.getElementById('keyValidation');
          validationDiv.className = 'key-validation invalid';
          validationDiv.textContent = '‚ö†Ô∏è Key format doesn\'t match selected service. Please correct before saving.';
          return;
        }
      }
      
      try {
        const response = await fetch('/api/keys', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, service, url, value, autoShare })
        });
        
        if (response.ok) {
          const result = await response.json();
          let message = 'Key added successfully';
          if (result.autoShared) {
            message += ' and shared with OpenClaw Agent';
          } else if (autoShare) {
            message += ' (auto-share failed - OpenClaw Agent not connected)';
          }
          showAlert(message, result.autoShared ? 'success' : (autoShare ? 'warning' : 'success'));
          
          // Clear all fields
          document.getElementById('keyName').value = '';
          document.getElementById('keyService').value = '';
          document.getElementById('keyUrl').value = '';
          document.getElementById('keyValue').value = '';
          document.getElementById('autoShareKey').checked = false;
          document.getElementById('keyValidation').style.display = 'none';
          
          // Clear Twitter fields
          document.getElementById('twitterApiKey').value = '';
          document.getElementById('twitterApiSecret').value = '';
          document.getElementById('twitterAccessToken').value = '';
          document.getElementById('twitterAccessTokenSecret').value = '';
          document.getElementById('twitterBearerToken').value = '';
          document.getElementById('twitterClientId').value = '';
          document.getElementById('twitterClientSecret').value = '';
          
          // Reset field visibility
          onServiceChange();
          
          toggleAddForm();
          loadKeys();
        } else {
          const error = await response.json();
          showAlert(error.error, 'error');
        }
      } catch (e) {
        showAlert('Failed to add key', 'error');
      }
    }
    
    async function shareKey(id) {
      const btn = document.getElementById(`share-btn-${id}`);
      const originalText = btn ? btn.textContent : 'Share with OpenClaw Agent';

      if (btn) {
        btn.textContent = 'Sharing...';
        btn.disabled = true;
      }

      try {
        const response = await fetch(`/api/keys/${id}/share`, {
          method: 'POST'
        });

        if (response.ok) {
          showAlert('‚úÖ Key shared with OpenClaw Agent successfully', 'success');
          loadKeys(); // Refresh to show shared status
        } else {
          const error = await response.json();
          showAlert(`‚ùå ${error.error}`, 'error');
        }
      } catch (e) {
        showAlert('‚ùå Failed to share key. Is OpenClaw Agent connected?', 'error');
      } finally {
        if (btn) {
          btn.textContent = originalText;
          btn.disabled = false;
        }
      }
    }

    async function unshareKey(id) {
      const btn = document.getElementById(`unshare-btn-${id}`);

      if (btn) {
        btn.textContent = 'Revoking...';
        btn.disabled = true;
      }

      try {
        const response = await fetch(`/api/keys/${id}/unshare`, {
          method: 'POST'
        });

        if (response.ok) {
          showAlert('‚úÖ Key sharing revoked', 'success');
          loadKeys(); // Refresh to show unshared status
        } else {
          const error = await response.json();
          showAlert(`‚ùå ${error.error}`, 'error');
        }
      } catch (e) {
        showAlert('‚ùå Failed to revoke sharing', 'error');
      }
    }

    // Edit key modal/form
    let editingKeyId = null;

    async function editKey(id) {
      const key = keys.find(k => k.id === id);
      if (!key) {
        showAlert('Key not found', 'error');
        return;
      }

      editingKeyId = id;

      // Get current value
      try {
        const response = await fetch(`/api/keys/${id}/value`);
        if (!response.ok) {
          showAlert('Failed to load key value', 'error');
          return;
        }
        const keyData = await response.json();

        // Populate edit form
        document.getElementById('editKeyName').value = key.name;
        document.getElementById('editKeyService').value = key.service || '';
        document.getElementById('editKeyUrl').value = key.url || '';
        document.getElementById('editKeyValue').value = keyData.value || '';
        document.getElementById('editResetRotation').checked = false;

        showEditForm();
      } catch (e) {
        showAlert('Failed to load key for editing', 'error');
      }
    }

    function showEditForm() {
      document.getElementById('editKeyForm').classList.add('active');
      document.getElementById('addKeyForm').classList.remove('active');
    }

    function hideEditForm() {
      document.getElementById('editKeyForm').classList.remove('active');
      editingKeyId = null;
    }

    async function saveEditedKey() {
      if (!editingKeyId) return;

      const name = document.getElementById('editKeyName').value;
      const service = document.getElementById('editKeyService').value;
      const url = document.getElementById('editKeyUrl').value;
      const value = document.getElementById('editKeyValue').value;
      const resetRotation = document.getElementById('editResetRotation').checked;

      if (!name || !value) {
        showAlert('Name and value are required', 'error');
        return;
      }

      const btn = document.getElementById('saveEditBtn');
      const originalText = btn.textContent;
      btn.textContent = 'Saving...';
      btn.disabled = true;

      try {
        const response = await fetch(`/api/keys/${editingKeyId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, service, url, value, resetRotation })
        });

        if (response.ok) {
          showAlert(resetRotation ? '‚úÖ Key updated and rotation timer reset' : '‚úÖ Key updated successfully', 'success');
          hideEditForm();
          loadKeys();
        } else {
          const error = await response.json();
          showAlert(`‚ùå ${error.error}`, 'error');
        }
      } catch (e) {
        showAlert('‚ùå Failed to update key', 'error');
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    async function shareAllKeys() {
      const btn = document.getElementById('shareAllBtn');
      const status = document.getElementById('shareAllStatus');
      
      btn.disabled = true;
      btn.textContent = 'üì§ Sharing...';
      status.style.display = 'block';
      status.textContent = 'Sharing keys with OpenClaw Agent...';
      
      try {
        const response = await fetch('/api/keys/share-all', {
          method: 'POST'
        });
        
        if (response.ok) {
          const result = await response.json();
          const message = `‚úÖ Shared ${result.success} keys. ${result.failed > 0 ? `${result.failed} failed.` : ''}`;
          showAlert(message, result.failed > 0 ? 'warning' : 'success');
          status.textContent = result.failed > 0 
            ? `Shared ${result.success}, failed ${result.failed}. Errors: ${result.errors.join(', ')}`
            : `Successfully shared all ${result.success} keys!`;
          loadKeys();
        } else {
          const error = await response.json();
          showAlert(`‚ùå ${error.error}`, 'error');
          status.textContent = `Failed: ${error.error}`;
        }
      } catch (e) {
        showAlert('‚ùå Failed to share keys. Is OpenClaw Agent connected?', 'error');
        status.textContent = 'Failed: OpenClaw Agent not connected';
      } finally {
        btn.disabled = false;
        renderKeys(); // Update button text
      }
    }
    
    async function deleteKey(id) {
      if (!confirm('Are you sure you want to delete this key?')) return;
      
      try {
        const response = await fetch(`/api/keys/${id}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showAlert('Key deleted', 'success');
          loadKeys();
        }
      } catch (e) {
        showAlert('Failed to delete key', 'error');
      }
    }
    
    // Fetch WebSocket token from server
    async function getWsToken() {
      try {
        const response = await fetch('/api/ws-token');
        const data = await response.json();
        return data.token;
      } catch (e) {
        console.error('Failed to get WebSocket token:', e);
        return null;
      }
    }
    
    function connectWebSocket() {
      // Don't connect if on unlock/setup screen
      const unlockScreen = document.getElementById('unlockScreen');
      const setupScreen = document.getElementById('setupScreen');
      if ((unlockScreen && unlockScreen.classList.contains('active')) || 
          (setupScreen && setupScreen.classList.contains('active'))) {
        console.log('Not connecting WebSocket - on auth screen');
        return;
      }
      
      if (ws && (ws.readyState === WebSocket.CONNECTING || ws.readyState === WebSocket.OPEN)) {
        console.log('WebSocket already connected or connecting');
        return;
      }
      
      console.log('Connecting WebSocket...');
      ws = new WebSocket('ws://localhost:8766');
      
      ws.onopen = async () => {
        console.log('WebSocket connected, authenticating...');
        // Get token and authenticate
        const token = await getWsToken();
        if (token) {
          ws.send(JSON.stringify({ type: 'auth', token: token }));
        } else {
          console.error('No token available for authentication');
        }
      };
      
      ws.onclose = () => {
        console.log('WebSocket closed');
        document.getElementById('connectionDot').classList.remove('connected');
        document.getElementById('connectionText').textContent = '‚ùå OpenClaw Agent disconnected';
        const connectDot = document.getElementById('connectStatusDot');
        if (connectDot) {
          connectDot.classList.remove('connected');
          document.getElementById('connectStatusText').textContent = 'Disconnected. Retrying...';
        }
        // Disable share all button
        const shareAllBtn = document.getElementById('shareAllBtn');
        if (shareAllBtn) {
          shareAllBtn.disabled = true;
        }
        // Only retry if on vault screen
        const vaultScreen = document.getElementById('vaultScreen');
        if (vaultScreen && vaultScreen.classList.contains('active')) {
          setTimeout(connectWebSocket, 5000);
        }
      };
      
      ws.onerror = (error) => {
        console.log('WebSocket error:', error);
        document.getElementById('connectionText').textContent = '‚ö†Ô∏è Connection error';
      };
      
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log('WebSocket message:', data.type);
        
        if (data.type === 'auth_success') {
          console.log('WebSocket authenticated');
          document.getElementById('connectionDot').classList.add('connected');
          document.getElementById('connectionText').textContent = '‚úÖ OpenClaw Agent connected';
          const connectDot = document.getElementById('connectStatusDot');
          if (connectDot) {
            connectDot.classList.add('connected');
            document.getElementById('connectStatusText').textContent = 'Connected! Ready to share keys.';
          }
          // Enable share all button if there are unshared keys
          renderKeys();
        } else if (data.type === 'key_received') {
          showAlert(`‚úÖ OpenClaw Agent received: ${data.keyName}`, 'success');
          loadKeys(); // Refresh to show updated shared status
        }
      };
    }
    
    function showAlert(message, type) {
      const alerts = document.getElementById('alerts');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alerts.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }
    
    // Initialize
    checkStatus();
    
    // Fallback button handler for create vault
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, attaching fallback handlers');
      const createBtn = document.getElementById('createVaultBtn');
      if (createBtn) {
        console.log('Create vault button found');
        createBtn.addEventListener('click', function(e) {
          console.log('Create vault button clicked (fallback)');
          e.preventDefault();
          e.stopPropagation();
          initializeVault();
          return false;
        });
      } else {
        console.log('Create vault button NOT found');
      }
    });
  </script>
</body>
</html>
